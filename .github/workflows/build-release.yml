name: Build and Release

on:
    push:
        tags:
            - "v*" # Triggers on tags like v1.0.0, v2.1.3, etc.
    workflow_dispatch: # Allows manual triggering from GitHub UI
        inputs:
            version:
                description: "Version tag (e.g., v1.0.0)"
                required: true
                type: string

env:
    PLUGIN_ID: hc-webhook-plugin
    BINARY_NAME: hc-webhook-plugin

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: linux
                      arch: amd64
                      goos: linux
                      goarch: amd64
                      binary_suffix: ""
                    - platform: linux
                      arch: arm64
                      goos: linux
                      goarch: arm64
                      binary_suffix: ""
                    - platform: darwin
                      arch: amd64
                      goos: darwin
                      goarch: amd64
                      binary_suffix: ""
                    - platform: darwin
                      arch: arm64
                      goos: darwin
                      goarch: arm64
                      binary_suffix: ""
                    - platform: windows
                      arch: amd64
                      goos: windows
                      goarch: amd64
                      binary_suffix: ""  # Apito CLI outputs same name for all platforms

        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.22"

            - name: Install Apito CLI
              run: |
                  curl -fsSL https://get.apito.io/install.sh | bash

            - name: Verify Apito CLI installation
              run: |
                  export PATH="$HOME/.apito/bin:$PATH"
                  apito --version || echo "Apito CLI installed"

            - name: Build plugin
              run: |
                  export PATH="$HOME/.apito/bin:$PATH"
                  apito plugin build --build system --platform ${{ matrix.goos }} --arch ${{ matrix.goarch }} --type production
                  ls -la ${{ env.BINARY_NAME }}${{ matrix.binary_suffix }} || ls -la

            - name: Verify binary exists
              run: |
                  if [ ! -f "${{ env.BINARY_NAME }}${{ matrix.binary_suffix }}" ]; then
                    echo "‚ùå Error: Binary '${{ env.BINARY_NAME }}${{ matrix.binary_suffix }}' not found after build"
                    exit 1
                  fi
                  echo "‚úÖ Binary found: $(ls -lh ${{ env.BINARY_NAME }}${{ matrix.binary_suffix }})"

            - name: Install zip utility
              run: sudo apt-get update && sudo apt-get install -y zip

            - name: Create zip archive
              id: zip
              run: |
                  TAG="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref_name }}"
                  ZIP_NAME="${{ env.PLUGIN_ID }}-${TAG}-${{ matrix.platform }}-${{ matrix.arch }}.zip"
                  zip "$ZIP_NAME" "${{ env.BINARY_NAME }}" config.yml
                  echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
                  echo "üì¶ Created: $ZIP_NAME"
                  ls -lh "$ZIP_NAME"

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: build-${{ matrix.platform }}-${{ matrix.arch }}
                  path: ${{ steps.zip.outputs.zip_name }}

    release:
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Extract version from tag
              id: tag_version
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    TAG_NAME="${{ github.event.inputs.version }}"
                  else
                    TAG_NAME="${GITHUB_REF#refs/tags/}"
                  fi
                  VERSION=${TAG_NAME#v}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
                  echo "üì¶ Version: $VERSION"
                  echo "üè∑Ô∏è  Tag: $TAG_NAME"

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Flatten artifact paths
              run: |
                  mkdir -p release
                  for f in artifacts/build-*/*.zip; do
                    [ -f "$f" ] && cp "$f" release/
                  done
                  ls -la release/

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.tag_version.outputs.tag }}
                  name: Release ${{ steps.tag_version.outputs.tag }}
                  body: |
                      Release version ${{ steps.tag_version.outputs.version }} of ${{ env.PLUGIN_ID }}

                      ## Installation

                      Download the zip for your platform and extract it. Each zip contains the plugin binary and config.yml.

                      ## Platforms

                      - Linux AMD64
                      - Linux ARM64
                      - macOS AMD64 (Intel)
                      - macOS ARM64 (Apple Silicon)
                      - Windows AMD64

                      ## Version

                      ${{ steps.tag_version.outputs.version }}
                  files: release/*.zip
                  draft: false
                  prerelease: false
